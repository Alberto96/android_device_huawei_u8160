#!/system/bin/sh
# madconfig (for CyanogenMod 9)
# by psyke83

swapfile="/data/local/userinit.d/enableswap"
modelfile="/data/local/userinit.d/enableu8180"
ksmfile="/data/local/userinit.d/enableksm"

if [ "$1" = "" ]; then
    echo ""
    echo "Usage: madconfig [option]"
    echo "Options:"
    echo ""
    echo " * ksmon   - enable Kernel Samepage Merging (KSM)"
    echo " * ksmoff  - disable Kernel Samepage Merging (KSM)"
    echo " * swapon  - enable swap"
    echo " * swapoff - disable swap"
    echo " * u8180   - enable U8180 ROM branding"
    echo " * u8160   - disable U8180 ROM branding"
    echo ""
    echo "MAD Team ROM status:"
    echo ""
    echo "Swap size:   " `free | grep Swap | awk ' { print ($2) } '`"KB"

    echo -n "KSM:          "
    if [ -f $ksmfile ]; then
        echo "enabled"
    else
        echo "disabled"
    fi
    echo -n "Swap:         "
    if [ -f $swapfile ]; then
        echo "enabled"
        echo "Swap size:   " `free | grep Swap | awk ' { print ($2) } '`"KB"
    else
        echo "disabled"
    fi
    if [ -f $modelfile ]; then
        echo "ROM branding: U8180"
     else
         echo "ROM branding: U8160 (default)"
    fi
         echo ""
fi

if [ "$(id)" != "uid=0(root) gid=0(root)" ]; then
    echo "You must run this script as superuser (su)!"
    echo "Aborting."
    echo ""
    exit
fi

# Create userinit.d folder if necessary
if [ ! -d /data/local/userinit.d ]; then
    mkdir /data/local/userinit.d
    busybox chmod 777 /data/local/userinit.d
    busybox chown system:system /data/local/userinit.d
fi

if [ "$1" = "ksmon" ]; then
    echo "echo 1 > /sys/kernel/mm/ksm/run" >$ksmfile
    busybox chmod +x $ksmfile
    $ksmfile
    echo "KSM enabled! Setting will be kept on reboot."
fi

if [ "$1" = "ksmoff" ]; then
    rm $ksmfile
    echo 0 > /sys/kernel/mm/ksm/run
    echo "KSM disabled! Setting will be kept on reboot."
fi

if [ "$1" = "swapon" ]; then
    echo "swapon /dev/block/mmcblk0p3" >$swapfile
    busybox chmod +x $swapfile
    $swapfile
    echo "Swap enabled! Setting will be kept on reboot."
fi

if [ "$1" = "swapoff" ]; then
    rm $swapfile
    swapoff /dev/block/mmcblk0p3
    echo "Swap disabled! Setting will be kept on reboot."
fi

if [ "$1" = "u8180" ]; then
    echo "if [ `cat /system/build.prop | grep 'ro.product.model='` = 'ro.product.model=U8160' ]; then mount -o remount,rw /system; sleep 2; sed -e 's/ro.product.model=U8160/ro.product.model=U8180/g' -i /system/build.prop; sleep 2; mount -o remount,ro /system; fi" >$modelfile
    busybox chmod +x $modelfile
    $modelfile
    echo "U8180 branding enabled! Setting will be kept on ROM upgrade."
    echo "Please reboot for changes to take effect."
fi

if [ "$1" = "u8160" ]; then
    sleep 2; mount -o remount,rw /system
    sed -e 's/ro.product.model=U8180/ro.product.model=U8160/g' -i /system/build.prop
    sleep 2; mount -o remount,ro /system
    if [ -f $modelfile ]; then rm $modelfile; fi
    echo "U8160 branding restored."
    echo "Please reboot for changes to take effect."
fi

exit
